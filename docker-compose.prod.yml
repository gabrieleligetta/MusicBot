version: '3.9'

services:
  # ---------------------------------------------------------------------------
  # SERVIZIO 1: Sidecar PO Token Provider (Implementazione Rust)
  # Repository: jim60105/bgutil-ytdlp-pot-provider-rs
  # Registry: GHCR (GitHub Container Registry)
  # ---------------------------------------------------------------------------
  bgutil-sidecar:
    image: ghcr.io/jim60105/bgutil-pot:latest
    # In produzione su server Linux (probabilmente AMD64), non forziamo la piattaforma
    # a meno che non sia necessario. Se il server Ã¨ ARM, l'immagine deve supportarlo.
    # platform: linux/amd64 
    container_name: bgutil-sidecar
    restart: always
    environment:
      - RUST_LOG=info
      - SERVER_PORT=4416

  # ---------------------------------------------------------------------------
  # SERVIZIO 2: MusicBot (Target Application)
  # ---------------------------------------------------------------------------
  musicbot:
    container_name: musicbot
    build: 
      context: .
      dockerfile: Dockerfile
    restart: always
    
    # CRITICO: Condivisione del namespace di rete con il sidecar.
    network_mode: service:bgutil-sidecar
    
    depends_on:
      - bgutil-sidecar
        
    env_file:
      - .env
      
    environment:
      - NODE_ENV=production
      # Define the URL for the code to use. 
      # Since we use network_mode: service:bgutil-sidecar, we use localhost.
      # And we must match the port defined in bgutil-sidecar (4416).
      - POT_URL=http://127.0.0.1:4416
      
    volumes:
      # Persistenza del database
      - ./database.sqlite:/usr/src/app/database.sqlite
      # Persistenza delle playlist
      - ./Playlists:/usr/src/app/Playlists
      # Persistenza dei cookie (opzionale)
      - ./cookies.json:/usr/src/app/cookies.json
