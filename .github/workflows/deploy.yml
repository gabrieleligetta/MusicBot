name: Deploy to Google Cloud

on:
  push:
    branches: [ "master" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸš€ Deploy via SSH
        uses: appleboy/ssh-action@master
        env:
          BOT_ENV: ${{ secrets.SSH_ENV }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          envs: BOT_ENV
          script: |
            set -e
            
            # Definisci la cartella di destinazione
            TARGET_DIR="/home/${{ secrets.SSH_USER }}/musicbot-docker"
            REPO_URL="https://github.com/gabrieleligetta/musicbot.git"
            
            echo "ğŸ“‚ Target directory: $TARGET_DIR"
            
            # Se la cartella non esiste, clona il repo
            if [ ! -d "$TARGET_DIR" ]; then
              echo "âš ï¸ Directory not found. Cloning repository..."
              git clone "$REPO_URL" "$TARGET_DIR"
            fi
            
            # Entra nella cartella
            cd "$TARGET_DIR"
            
            # Crea/Aggiorna il file .env dal secret
            echo "ğŸ“ Updating .env file..."
            echo "$BOT_ENV" > .env
            
            # Scarica le modifiche
            echo "â¬‡ï¸ Pulling latest changes..."
            git fetch origin master
            git reset --hard origin/master
            
            # Ricostruisci e riavvia i container usando il file di produzione
            echo "ğŸ”„ Rebuilding containers..."
            docker compose -f docker-compose.prod.yml down
            docker compose -f docker-compose.prod.yml up -d --build
            
            # Pulisci le immagini vecchie
            echo "ğŸ§¹ Cleaning up..."
            docker image prune -f
            
            echo "âœ… Deploy Success!"
