deploy:
  needs: build-and-push
  runs-on: ubuntu-latest

  steps:
    - name: ğŸš€ Deploy via SSH
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        port: 22
        # Rimuoviamo 'envs' perchÃ© iniettiamo i valori direttamente nello script sotto
        script: |
          set -e
          
          echo "ğŸ“‚ Entro nella cartella del progetto..."
          cd ~/musicbot-docker
          
          # 1. Aggiorna il file docker-compose.yml
          echo "â¬‡ï¸ Aggiorno repository..."
          git pull origin master
          
          # 2. Login a GitHub Container Registry
          # MODIFICA FONDAMENTALE: Usiamo ${{ secrets.CR_PAT }} direttamente qui
          echo "ğŸ” Eseguo Login al Registry..."
          echo "${{ secrets.CR_PAT }}" | docker login ghcr.io -u "gabrieleligetta" --password-stdin
          
          # 3. Scarica la nuova immagine costruita da GitHub
          echo "â¬‡ï¸ Scarico la nuova immagine..."
          docker compose pull
          
          # 4. Riavvia i container
          echo "ğŸ”„ Riavvio i container..."
          docker compose up -d
          
          # 5. Pulizia immagini vecchie
          echo "ğŸ§¹ Pulizia..."
          docker image prune -f
          
          echo "âœ… Deploy Completato con Successo!"
