version: '3.9'

services:
  # ---------------------------------------------------------------------------
  # SERVIZIO 1: POT Token Provider (Server)
  # ---------------------------------------------------------------------------
  pot-provider:
    image: ghcr.io/jim60105/yt-dlp:pot
    container_name: yt-dlp-pot-provider
    restart: always
    # CRITICAL: Override the default entrypoint to run the bgutil server
    # We bind to 0.0.0.0 to allow access from other containers
    entrypoint: ["bgutil-pot", "server", "--bind", "0.0.0.0:4444"]
    ports:
      - "4444:4444"
    environment:
      - RUST_LOG=info
    networks:
      - musicbot_network

  # ---------------------------------------------------------------------------
  # SERVIZIO 2: MusicBot
  # ---------------------------------------------------------------------------
  musicbot:
    container_name: musicbot
    # Usa l'immagine costruita localmente o da GHCR, ma assicurati che abbia le dipendenze pip aggiornate
    image: ghcr.io/gabrieleligetta/musicbot:latest
    restart: unless-stopped
    depends_on:
      - pot-provider
    env_file:
      - .env
    volumes:
      - ./database.sqlite:/usr/src/app/database.sqlite
      - ./Playlists:/usr/src/app/Playlists
      - ./cookies.json:/usr/src/app/cookies.json
    networks:
      - musicbot_network

networks:
  musicbot_network:
    driver: bridge
